metadata:
  name: ubody2d-pose_hrnet_w32
  namespace: cvat
  annotations:
    name: UBody 2D via MMPose
    type: detector
    framework: pytorch
    spec: |
      [
        {
          "name": "body",
          "type": "skeleton",
          "elements": [
              { "id": 0, "name": "1", "type": "points" },
              { "id": 1, "name": "2", "type": "points" },
              { "id": 2, "name": "3", "type": "points" },
              { "id": 3, "name": "4", "type": "points" },
              { "id": 4, "name": "5", "type": "points" },
              { "id": 5, "name": "6", "type": "points" },
              { "id": 6, "name": "7", "type": "points" },
              { "id": 7, "name": "8", "type": "points" },
              { "id": 8, "name": "9", "type": "points" },
              { "id": 9, "name": "10", "type": "points" },
              { "id": 10, "name": "11", "type": "points" },
              { "id": 11, "name": "12", "type": "points" },
              { "id": 12, "name": "13", "type": "points" },
              { "id": 13, "name": "14", "type": "points" },
              { "id": 14, "name": "15", "type": "points" },
              { "id": 15, "name": "16", "type": "points" },
              { "id": 16, "name": "17", "type": "points" }
          ]
        },
        {
          "name": "feet",
          "type": "skeleton",
          "elements": [
              { "id": 17, "name": "1", "type": "points" },
              { "id": 18, "name": "2", "type": "points" },
              { "id": 19, "name": "3", "type": "points" },
              { "id": 20, "name": "4", "type": "points" },
              { "id": 21, "name": "5", "type": "points" },
              { "id": 22, "name": "6", "type": "points" }
          ]
        },
        {
          "name": "face",
          "type": "skeleton",
          "elements": [
              { "id": 23, "name": "1", "type": "points" },
              { "id": 24, "name": "2", "type": "points" },
              { "id": 25, "name": "3", "type": "points" },
              { "id": 26, "name": "4", "type": "points" },
              { "id": 27, "name": "5", "type": "points" },
              { "id": 28, "name": "6", "type": "points" },
              { "id": 29, "name": "7", "type": "points" },
              { "id": 30, "name": "8", "type": "points" },
              { "id": 31, "name": "9", "type": "points" },
              { "id": 32, "name": "10", "type": "points" },
              { "id": 33, "name": "11", "type": "points" },
              { "id": 34, "name": "12", "type": "points" },
              { "id": 35, "name": "13", "type": "points" },
              { "id": 36, "name": "14", "type": "points" },
              { "id": 37, "name": "15", "type": "points" },
              { "id": 38, "name": "16", "type": "points" },
              { "id": 39, "name": "17", "type": "points" },
              { "id": 40, "name": "18", "type": "points" },
              { "id": 41, "name": "19", "type": "points" },
              { "id": 42, "name": "20", "type": "points" },
              { "id": 43, "name": "21", "type": "points" },
              { "id": 44, "name": "22", "type": "points" },
              { "id": 45, "name": "23", "type": "points" },
              { "id": 46, "name": "24", "type": "points" },
              { "id": 47, "name": "25", "type": "points" },
              { "id": 48, "name": "26", "type": "points" },
              { "id": 49, "name": "27", "type": "points" },
              { "id": 50, "name": "28", "type": "points" },
              { "id": 51, "name": "29", "type": "points" },
              { "id": 52, "name": "30", "type": "points" },
              { "id": 53, "name": "31", "type": "points" },
              { "id": 54, "name": "32", "type": "points" },
              { "id": 55, "name": "33", "type": "points" },
              { "id": 56, "name": "34", "type": "points" },
              { "id": 57, "name": "35", "type": "points" },
              { "id": 58, "name": "36", "type": "points" },
              { "id": 59, "name": "37", "type": "points" },
              { "id": 60, "name": "38", "type": "points" },
              { "id": 61, "name": "39", "type": "points" },
              { "id": 62, "name": "40", "type": "points" },
              { "id": 63, "name": "41", "type": "points" },
              { "id": 64, "name": "42", "type": "points" },
              { "id": 65, "name": "43", "type": "points" },
              { "id": 66, "name": "44", "type": "points" },
              { "id": 67, "name": "45", "type": "points" },
              { "id": 68, "name": "46", "type": "points" },
              { "id": 69, "name": "47", "type": "points" },
              { "id": 70, "name": "48", "type": "points" },
              { "id": 71, "name": "49", "type": "points" },
              { "id": 72, "name": "50", "type": "points" },
              { "id": 73, "name": "51", "type": "points" },
              { "id": 74, "name": "52", "type": "points" },
              { "id": 75, "name": "53", "type": "points" },
              { "id": 76, "name": "54", "type": "points" },
              { "id": 77, "name": "55", "type": "points" },
              { "id": 78, "name": "56", "type": "points" },
              { "id": 79, "name": "57", "type": "points" },
              { "id": 80, "name": "58", "type": "points" },
              { "id": 81, "name": "59", "type": "points" },
              { "id": 82, "name": "60", "type": "points" },
              { "id": 83, "name": "61", "type": "points" },
              { "id": 84, "name": "62", "type": "points" },
              { "id": 85, "name": "63", "type": "points" },
              { "id": 86, "name": "64", "type": "points" },
              { "id": 87, "name": "65", "type": "points" },
              { "id": 88, "name": "66", "type": "points" },
              { "id": 89, "name": "67", "type": "points" },
              { "id": 90, "name": "68", "type": "points" }
          ]
        }, {
          "name": "hands",
          "type": "skeleton",
          "elements": [
              { "id": 91, "name": "1", "type": "points" },
              { "id": 92, "name": "2", "type": "points" },
              { "id": 93, "name": "3", "type": "points" },
              { "id": 94, "name": "4", "type": "points" },
              { "id": 95, "name": "5", "type": "points" },
              { "id": 96, "name": "6", "type": "points" },
              { "id": 97, "name": "7", "type": "points" },
              { "id": 98, "name": "8", "type": "points" },
              { "id": 99, "name": "9", "type": "points" },
              { "id": 100, "name": "10", "type": "points" },
              { "id": 101, "name": "11", "type": "points" },
              { "id": 102, "name": "12", "type": "points" },
              { "id": 103, "name": "13", "type": "points" },
              { "id": 104, "name": "14", "type": "points" },
              { "id": 105, "name": "15", "type": "points" },
              { "id": 106, "name": "16", "type": "points" },
              { "id": 107, "name": "17", "type": "points" },
              { "id": 108, "name": "18", "type": "points" },
              { "id": 109, "name": "19", "type": "points" },
              { "id": 110, "name": "20", "type": "points" },
              { "id": 111, "name": "21", "type": "points" },
              { "id": 112, "name": "22", "type": "points" },
              { "id": 113, "name": "23", "type": "points" },
              { "id": 114, "name": "24", "type": "points" },
              { "id": 115, "name": "25", "type": "points" },
              { "id": 116, "name": "26", "type": "points" },
              { "id": 117, "name": "27", "type": "points" },
              { "id": 118, "name": "28", "type": "points" },
              { "id": 119, "name": "29", "type": "points" },
              { "id": 120, "name": "30", "type": "points" },
              { "id": 121, "name": "31", "type": "points" },
              { "id": 122, "name": "32", "type": "points" },
              { "id": 123, "name": "33", "type": "points" },
              { "id": 124, "name": "34", "type": "points" },
              { "id": 125, "name": "35", "type": "points" },
              { "id": 126, "name": "36", "type": "points" },
              { "id": 127, "name": "37", "type": "points" },
              { "id": 128, "name": "38", "type": "points" },
              { "id": 129, "name": "39", "type": "points" },
              { "id": 130, "name": "40", "type": "points" },
              { "id": 131, "name": "41", "type": "points" },
              { "id": 132, "name": "42", "type": "points" }
          ]
        }
      ]

spec:
  description: Whole Body points
  runtime: 'python:3.8'
  handler: main:handler
  eventTimeout: 30s

  build:
    image: cvat.pth.mmpose.ubody2d
    baseImage: python:3.8

    directives:
      preCopy:
        - kind: RUN
          value: apt update && apt install -y git libgl1 --no-install-recommends && rm -rf /var/lib/apt/lists/*
        - kind: WORKDIR
          value: /opt/nuclio
        - kind: RUN
          value: pip install openmim torch==2.0.0+cpu torchvision==0.15.1+cpu --extra-index-url https://download.pytorch.org/whl/cpu
        - kind: RUN
          value: mim install mmcv==2.0.1 mmdet==3.2.0 mmpose==1.2.0
        - kind: RUN
          value: git clone -b v1.2.0 --depth=1 https://github.com/open-mmlab/mmpose.git
        - kind: ADD
          value: https://download.openmmlab.com/mmpose/v1/wholebody_2d_keypoint/ubody/td-hm_hrnet-w32_8xb64-210e_ubody-coco-256x192-7c227391_20230807.pth ./
        - kind: ADD
          value: https://download.openmmlab.com/mmpose/v1/projects/rtmpose/rtmdet_nano_8xb32-100e_coco-obj365-person-05d8511e.pth ./

  triggers:
    myHttpTrigger:
      maxWorkers: 2
      kind: 'http'
      workerAvailabilityTimeoutMilliseconds: 10000
      attributes:
        maxRequestBodySize: 33554432 # 32MB

  platform:
    attributes:
      restartPolicy:
        name: always
        maximumRetryCount: 3
      mountMode: volume
