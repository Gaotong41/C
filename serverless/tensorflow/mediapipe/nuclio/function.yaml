# CONFIG
metadata:
  name: mediapipe-pose
  namespace: cvat
  annotations:
    name: Mediapipe human pose estimation
    type: detector
    framework: tensorflow
    spec: |
      [
        {
          "name" : "body",
          "type" : "skeleton",
          "svg"  : "<line x1=\"42.829742431640625\" y1=\"93.37168884277344\" x2=\"33.53919982910156\" y2=\"94.2162857055664\" data-type=\"edge\" data-node-from=\"31\" data-node-to=\"33\" stroke-width=\"0.5\"></line><line x1=\"39.9581184387207\" y1=\"88.64196014404297\" x2=\"33.53919982910156\" y2=\"94.2162857055664\" data-type=\"edge\" data-node-from=\"29\" data-node-to=\"33\" stroke-width=\"0.5\"></line><line x1=\"39.9581184387207\" y1=\"88.64196014404297\" x2=\"42.829742431640625\" y2=\"93.37168884277344\" data-type=\"edge\" data-node-from=\"29\" data-node-to=\"31\" stroke-width=\"0.5\"></line><line x1=\"35.735145568847656\" y1=\"69.83565521240234\" x2=\"39.9581184387207\" y2=\"88.64196014404297\" data-type=\"edge\" data-node-from=\"27\" data-node-to=\"29\" stroke-width=\"0.5\"></line><line x1=\"54.82298278808594\" y1=\"93.54061126708984\" x2=\"64.45136260986328\" y2=\"94.38520050048828\" data-type=\"edge\" data-node-from=\"30\" data-node-to=\"32\" stroke-width=\"0.5\"></line><line x1=\"57.863525390625\" y1=\"88.64196014404297\" x2=\"64.45136260986328\" y2=\"94.38520050048828\" data-type=\"edge\" data-node-from=\"28\" data-node-to=\"32\" stroke-width=\"0.5\"></line><line x1=\"57.863525390625\" y1=\"88.64196014404297\" x2=\"54.82298278808594\" y2=\"93.54061126708984\" data-type=\"edge\" data-node-from=\"28\" data-node-to=\"30\" stroke-width=\"0.5\"></line><line x1=\"62.59325408935547\" y1=\"69.55412292480469\" x2=\"57.863525390625\" y2=\"88.64196014404297\" data-type=\"edge\" data-node-from=\"26\" data-node-to=\"28\" stroke-width=\"0.5\"></line><line x1=\"39.9581184387207\" y1=\"50.35367202758789\" x2=\"35.735145568847656\" y2=\"69.83565521240234\" data-type=\"edge\" data-node-from=\"25\" data-node-to=\"27\" stroke-width=\"0.5\"></line><line x1=\"57.69460678100586\" y1=\"51.02934646606445\" x2=\"62.59325408935547\" y2=\"69.55412292480469\" data-type=\"edge\" data-node-from=\"24\" data-node-to=\"26\" stroke-width=\"0.5\"></line><line x1=\"57.69460678100586\" y1=\"51.02934646606445\" x2=\"39.9581184387207\" y2=\"50.35367202758789\" data-type=\"edge\" data-node-from=\"24\" data-node-to=\"25\" stroke-width=\"0.5\"></line><line x1=\"62.25541687011719\" y1=\"27.211780548095703\" x2=\"57.69460678100586\" y2=\"51.02934646606445\" data-type=\"edge\" data-node-from=\"12\" data-node-to=\"24\" stroke-width=\"0.5\"></line><line x1=\"35.90406799316406\" y1=\"26.70502471923828\" x2=\"39.9581184387207\" y2=\"50.35367202758789\" data-type=\"edge\" data-node-from=\"13\" data-node-to=\"25\" stroke-width=\"0.5\"></line><line x1=\"18.50541877746582\" y1=\"32.44826889038086\" x2=\"13.944607734680176\" y2=\"26.029348373413086\" data-type=\"edge\" data-node-from=\"17\" data-node-to=\"21\" stroke-width=\"0.5\"></line><line x1=\"11.410823822021484\" y1=\"32.27935028076172\" x2=\"13.944607734680176\" y2=\"26.029348373413086\" data-type=\"edge\" data-node-from=\"19\" data-node-to=\"21\" stroke-width=\"0.5\"></line><line x1=\"18.50541877746582\" y1=\"32.44826889038086\" x2=\"11.410823822021484\" y2=\"32.27935028076172\" data-type=\"edge\" data-node-from=\"17\" data-node-to=\"19\" stroke-width=\"0.5\"></line><line x1=\"18.50541877746582\" y1=\"32.44826889038086\" x2=\"19.181093215942383\" y2=\"27.042861938476562\" data-type=\"edge\" data-node-from=\"17\" data-node-to=\"23\" stroke-width=\"0.5\"></line><line x1=\"26.951364517211914\" y1=\"34.024845123291016\" x2=\"18.50541877746582\" y2=\"32.44826889038086\" data-type=\"edge\" data-node-from=\"15\" data-node-to=\"17\" stroke-width=\"0.5\"></line><line x1=\"86.9175796508789\" y1=\"31.772592544555664\" x2=\"83.87703704833984\" y2=\"26.029348373413086\" data-type=\"edge\" data-node-from=\"18\" data-node-to=\"20\" stroke-width=\"0.5\"></line><line x1=\"79.48514556884766\" y1=\"31.941511154174805\" x2=\"86.9175796508789\" y2=\"31.772592544555664\" data-type=\"edge\" data-node-from=\"16\" data-node-to=\"18\" stroke-width=\"0.5\"></line><line x1=\"79.48514556884766\" y1=\"31.941511154174805\" x2=\"83.87703704833984\" y2=\"26.029348373413086\" data-type=\"edge\" data-node-from=\"16\" data-node-to=\"20\" stroke-width=\"0.5\"></line><line x1=\"79.48514556884766\" y1=\"31.941511154174805\" x2=\"79.48514556884766\" y2=\"28.22529411315918\" data-type=\"edge\" data-node-from=\"16\" data-node-to=\"22\" stroke-width=\"0.5\"></line><line x1=\"71.20812225341797\" y1=\"36.22079086303711\" x2=\"79.48514556884766\" y2=\"31.941511154174805\" data-type=\"edge\" data-node-from=\"14\" data-node-to=\"16\" stroke-width=\"0.5\"></line><line x1=\"35.90406799316406\" y1=\"26.70502471923828\" x2=\"26.951364517211914\" y2=\"34.024845123291016\" data-type=\"edge\" data-node-from=\"13\" data-node-to=\"15\" stroke-width=\"0.5\"></line><line x1=\"62.25541687011719\" y1=\"27.211780548095703\" x2=\"71.20812225341797\" y2=\"36.22079086303711\" data-type=\"edge\" data-node-from=\"12\" data-node-to=\"14\" stroke-width=\"0.5\"></line><line x1=\"62.25541687011719\" y1=\"27.211780548095703\" x2=\"35.90406799316406\" y2=\"26.70502471923828\" data-type=\"edge\" data-node-from=\"12\" data-node-to=\"13\" stroke-width=\"0.5\"></line><line x1=\"51.78244400024414\" y1=\"18.427997589111328\" x2=\"46.54595947265625\" y2=\"17.921241760253906\" data-type=\"edge\" data-node-from=\"10\" data-node-to=\"11\" stroke-width=\"0.5\"></line><line x1=\"44.350013732910156\" y1=\"9.644214630126953\" x2=\"40.29595947265625\" y2=\"11.840160369873047\" data-type=\"edge\" data-node-from=\"6\" data-node-to=\"9\" stroke-width=\"0.5\"></line><line x1=\"49.248661041259766\" y1=\"14.542862892150879\" x2=\"44.350013732910156\" y2=\"9.644214630126953\" data-type=\"edge\" data-node-from=\"1\" data-node-to=\"6\" stroke-width=\"0.5\"></line><line x1=\"53.809471130371094\" y1=\"9.813133239746094\" x2=\"59.21487808227539\" y2=\"12.177997589111328\" data-type=\"edge\" data-node-from=\"3\" data-node-to=\"8\" stroke-width=\"0.5\"></line><line x1=\"49.248661041259766\" y1=\"14.542862892150879\" x2=\"53.809471130371094\" y2=\"9.813133239746094\" data-type=\"edge\" data-node-from=\"1\" data-node-to=\"3\" stroke-width=\"0.5\"></line><circle r=\"0.75\" cx=\"49.248661041259766\" cy=\"14.542862892150879\" data-type=\"element node\" data-element-id=\"1\" data-node-id=\"1\" data-label-name=\"1\"></circle><circle r=\"0.75\" cx=\"51.613525390625\" cy=\"9.813133239746094\" data-type=\"element node\" data-element-id=\"2\" data-node-id=\"2\" data-label-name=\"2\"></circle><circle r=\"0.75\" cx=\"53.809471130371094\" cy=\"9.813133239746094\" data-type=\"element node\" data-element-id=\"3\" data-node-id=\"3\" data-label-name=\"3\"></circle><circle r=\"0.75\" cx=\"55.83649826049805\" cy=\"9.982051849365234\" data-type=\"element node\" data-element-id=\"4\" data-node-id=\"4\" data-label-name=\"4\"></circle><circle r=\"0.75\" cx=\"46.54595947265625\" cy=\"9.644214630126953\" data-type=\"element node\" data-element-id=\"5\" data-node-id=\"5\" data-label-name=\"5\"></circle><circle r=\"0.75\" cx=\"44.350013732910156\" cy=\"9.644214630126953\" data-type=\"element node\" data-element-id=\"6\" data-node-id=\"6\" data-label-name=\"6\"></circle><circle r=\"0.75\" cx=\"42.660823822021484\" cy=\"9.475295066833496\" data-type=\"element node\" data-element-id=\"7\" data-node-id=\"7\" data-label-name=\"7\"></circle><circle r=\"0.75\" cx=\"59.21487808227539\" cy=\"12.177997589111328\" data-type=\"element node\" data-element-id=\"8\" data-node-id=\"8\" data-label-name=\"8\"></circle><circle r=\"0.75\" cx=\"40.29595947265625\" cy=\"11.840160369873047\" data-type=\"element node\" data-element-id=\"9\" data-node-id=\"9\" data-label-name=\"9\"></circle><circle r=\"0.75\" cx=\"51.78244400024414\" cy=\"18.427997589111328\" data-type=\"element node\" data-element-id=\"10\" data-node-id=\"10\" data-label-name=\"10\"></circle><circle r=\"0.75\" cx=\"46.54595947265625\" cy=\"17.921241760253906\" data-type=\"element node\" data-element-id=\"11\" data-node-id=\"11\" data-label-name=\"11\"></circle><circle r=\"0.75\" cx=\"62.25541687011719\" cy=\"27.211780548095703\" data-type=\"element node\" data-element-id=\"12\" data-node-id=\"12\" data-label-name=\"12\"></circle><circle r=\"0.75\" cx=\"35.90406799316406\" cy=\"26.70502471923828\" data-type=\"element node\" data-element-id=\"13\" data-node-id=\"13\" data-label-name=\"13\"></circle><circle r=\"0.75\" cx=\"71.20812225341797\" cy=\"36.22079086303711\" data-type=\"element node\" data-element-id=\"14\" data-node-id=\"14\" data-label-name=\"14\"></circle><circle r=\"0.75\" cx=\"26.951364517211914\" cy=\"34.024845123291016\" data-type=\"element node\" data-element-id=\"15\" data-node-id=\"15\" data-label-name=\"15\"></circle><circle r=\"0.75\" cx=\"79.48514556884766\" cy=\"31.941511154174805\" data-type=\"element node\" data-element-id=\"16\" data-node-id=\"16\" data-label-name=\"16\"></circle><circle r=\"0.75\" cx=\"18.50541877746582\" cy=\"32.44826889038086\" data-type=\"element node\" data-element-id=\"17\" data-node-id=\"17\" data-label-name=\"17\"></circle><circle r=\"0.75\" cx=\"86.9175796508789\" cy=\"31.772592544555664\" data-type=\"element node\" data-element-id=\"18\" data-node-id=\"18\" data-label-name=\"18\"></circle><circle r=\"0.75\" cx=\"11.410823822021484\" cy=\"32.27935028076172\" data-type=\"element node\" data-element-id=\"19\" data-node-id=\"19\" data-label-name=\"19\"></circle><circle r=\"0.75\" cx=\"83.87703704833984\" cy=\"26.029348373413086\" data-type=\"element node\" data-element-id=\"20\" data-node-id=\"20\" data-label-name=\"20\"></circle><circle r=\"0.75\" cx=\"13.944607734680176\" cy=\"26.029348373413086\" data-type=\"element node\" data-element-id=\"21\" data-node-id=\"21\" data-label-name=\"21\"></circle><circle r=\"0.75\" cx=\"79.48514556884766\" cy=\"28.22529411315918\" data-type=\"element node\" data-element-id=\"22\" data-node-id=\"22\" data-label-name=\"22\"></circle><circle r=\"0.75\" cx=\"19.181093215942383\" cy=\"27.042861938476562\" data-type=\"element node\" data-element-id=\"23\" data-node-id=\"23\" data-label-name=\"23\"></circle><circle r=\"0.75\" cx=\"57.69460678100586\" cy=\"51.02934646606445\" data-type=\"element node\" data-element-id=\"24\" data-node-id=\"24\" data-label-name=\"24\"></circle><circle r=\"0.75\" cx=\"39.9581184387207\" cy=\"50.35367202758789\" data-type=\"element node\" data-element-id=\"25\" data-node-id=\"25\" data-label-name=\"25\"></circle><circle r=\"0.75\" cx=\"62.59325408935547\" cy=\"69.55412292480469\" data-type=\"element node\" data-element-id=\"26\" data-node-id=\"26\" data-label-name=\"26\"></circle><circle r=\"0.75\" cx=\"35.735145568847656\" cy=\"69.83565521240234\" data-type=\"element node\" data-element-id=\"27\" data-node-id=\"27\" data-label-name=\"27\"></circle><circle r=\"0.75\" cx=\"57.863525390625\" cy=\"88.64196014404297\" data-type=\"element node\" data-element-id=\"28\" data-node-id=\"28\" data-label-name=\"28\"></circle><circle r=\"0.75\" cx=\"39.9581184387207\" cy=\"88.64196014404297\" data-type=\"element node\" data-element-id=\"29\" data-node-id=\"29\" data-label-name=\"29\"></circle><circle r=\"0.75\" cx=\"54.82298278808594\" cy=\"93.54061126708984\" data-type=\"element node\" data-element-id=\"30\" data-node-id=\"30\" data-label-name=\"30\"></circle><circle r=\"0.75\" cx=\"42.829742431640625\" cy=\"93.37168884277344\" data-type=\"element node\" data-element-id=\"31\" data-node-id=\"31\" data-label-name=\"31\"></circle><circle r=\"0.75\" cx=\"64.45136260986328\" cy=\"94.38520050048828\" data-type=\"element node\" data-element-id=\"32\" data-node-id=\"32\" data-label-name=\"32\"></circle><circle r=\"0.75\" cx=\"33.53919982910156\" cy=\"94.2162857055664\" data-type=\"element node\" data-element-id=\"33\" data-node-id=\"33\" data-label-name=\"33\"></circle>",
          "sublabels": [
            { "id":  0, "name": "1", "type": "points" },
            { "id":  1, "name": "2", "type": "points" },
            { "id":  2, "name": "3", "type": "points" },
            { "id":  3, "name": "4", "type": "points" },
            { "id":  4, "name": "5", "type": "points" },
            { "id":  5, "name": "6", "type": "points" },
            { "id":  6, "name": "7", "type": "points" },
            { "id":  7, "name": "8", "type": "points"},
            { "id":  8, "name": "9", "type": "points" },
            { "id":  9, "name": "10", "type": "points" },
            { "id":  10, "name": "11", "type": "points" },
            { "id":  11, "name": "12", "type": "points" },
            { "id":  12, "name": "13", "type": "points" },
            { "id":  13, "name": "14", "type": "points" },
            { "id":  14, "name": "15", "type": "points" },
            { "id":  15, "name": "16", "type": "points" },
            { "id":  16, "name": "17", "type": "points" },
            { "id":  17, "name": "18", "type": "points" },
            { "id":  18, "name": "19", "type": "points" },
            { "id":  19, "name": "20", "type": "points" },
            { "id":  20, "name": "21", "type": "points" },
            { "id":  21, "name": "22", "type": "points" },
            { "id":  22, "name": "23", "type": "points" },
            { "id":  23, "name": "24", "type": "points" },
            { "id":  24, "name": "25", "type": "points" },
            { "id":  25, "name": "26", "type": "points" },
            { "id":  26, "name": "27", "type": "points" },
            { "id":  27, "name": "28", "type": "points" },
            { "id":  28, "name": "29", "type": "points" },
            { "id":  29, "name": "30", "type": "points" },
            { "id":  30, "name": "31", "type": "points" },
            { "id":  31, "name": "32", "type": "points" },
            { "id":  32, "name": "33", "type": "points" }
          ]
        }

      ]

spec:
  description: Mediapipe body points 33 keypoints
  runtime: 'python:3.9'
  handler: main:handler
  eventTimeout: 30s

  build:
    image: cvat.tf.mediapipe.33kps
    baseImage: python:3.10

    directives:
      preCopy:
        - kind: RUN
          value: apt-get update && apt-get -y install curl python3 python3-pip libgl1-mesa-glx python-is-python3 libglib2.0-0
        - kind: RUN
          value: pip3 install mediapipe opencv-python numpy matplotlib pyyaml
        - kind: WORKDIR
          value: /opt/nuclio
        - kind: ADD
          value: https://storage.googleapis.com/mediapipe-models/pose_landmarker/pose_landmarker_heavy/float16/1/pose_landmarker_heavy.task ./

#    copy:
#     - skeleton.svg:/opt/nuclio/skeleton.svg
  triggers:
    myHttpTrigger:
      maxWorkers: 2
      kind: 'http'
      workerAvailabilityTimeoutMilliseconds: 10000
      attributes:
        maxRequestBodySize: 33554432 # 32MB

  platform:
    attributes:
      restartPolicy:
        name: always
        maximumRetryCount: 3
      mountMode: volume